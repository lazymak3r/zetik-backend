services:
  postgres:
    image: postgres:17-alpine
    container_name: zetik_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_DATABASE:-zetik_casino}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ./docker-postgres.sql:/docker-entrypoint-initdb.d/docker-postgres.sql
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "${DB_PORT:-5432}:5432"
    deploy:
      resources:
        limits:
          memory: 1024M
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-postgres} -d ${DB_DATABASE:-zetik_casino}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: ["postgres", "-c", "shared_buffers=128MB", "-c", "max_connections=100"]
    networks:
      - zetik-network

  redis:
    image: redis:7.4-alpine
    container_name: zetik_redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    deploy:
      resources:
        limits:
          memory: 2048M
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: ["redis-server", "--maxmemory", "2048mb", "--maxmemory-policy", "noeviction", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    networks:
      - zetik-network

  minio:
    image: minio/minio:latest
    container_name: zetik_minio
    volumes:
      - minio-data:/data
    ports:
      - '9000:9000'
      - '9001:9001'
    environment:
      - MINIO_ROOT_USER=minio
      - MINIO_ROOT_PASSWORD=minio123
    command: server /data --console-address ":9001"
    networks:
      - zetik-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  minio-init:
    image: minio/mc
    container_name: zetik_minio_init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: /bin/sh
    command: -c 'mc alias set minio http://minio:9000 minio minio123 && mc mb minio/zetik --ignore-existing && mc anonymous set download minio/zetik'
    networks:
      - zetik-network

  backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    container_name: zetik_backend
    restart: unless-stopped
    ports:
      - "${PORT:-4000}:4000"
    env_file:
      - apps/backend/.env
    environment:
      - PORT=4000
      - NODE_CLUSTER_ENABLED=true
      - NODE_CLUSTER_WORKERS=auto
      - DB_HOST=postgres
      - DB_PORT=5432
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/api"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - zetik-network

  crash-service:
    build:
      context: .
      dockerfile: apps/crash-service/Dockerfile
    container_name: zetik_crash_service
    restart: unless-stopped
    ports:
      - "4001:4001"
    env_file:
      - apps/backend/.env
    environment:
      - CRASH_SERVICE_PORT=4001
      - DB_HOST=postgres
      - DB_PORT=5432
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
      - ENABLE_CRASH_GAME_LOOP=true
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - zetik-network

  bet-feed-service:
    build:
      context: .
      dockerfile: apps/bet-feed-service/Dockerfile
    container_name: zetik_bet_feed_service
    restart: unless-stopped
    ports:
      - "4004:4004"
    env_file:
      - apps/backend/.env
    environment:
      - BET_FEED_SERVICE_PORT=4004
      - DB_HOST=postgres
      - DB_PORT=5432
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - zetik-network

  fireblocks-service:
    build:
      context: .
      dockerfile: apps/fireblocks-service/Dockerfile
    container_name: zetik_fireblocks_service
    restart: unless-stopped
    ports:
      - "4002:4002"
    env_file:
      - apps/backend/.env
    environment:
      - FIREBLOCKS_SERVICE_PORT=4002
      - DB_HOST=postgres
      - DB_PORT=5432
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4002/api"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - zetik-network

  currency-rate-service:
    build:
      context: .
      dockerfile: apps/currency-rate-service/Dockerfile
    container_name: zetik_currency_rate_service
    restart: unless-stopped
    env_file:
      - apps/backend/.env
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - zetik-network

  bonus-service:
    build:
      context: .
      dockerfile: apps/bonus-service/Dockerfile
    container_name: zetik_bonus_service
    restart: unless-stopped
    ports:
      - "4003:4003"
    env_file:
      - apps/backend/.env
    environment:
      - BONUS_SERVICE_PORT=4003
      - DB_HOST=postgres
      - DB_PORT=5432
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - zetik-network

  race-service:
    build:
      context: .
      dockerfile: apps/race-service/Dockerfile
    container_name: zetik_race_service
    restart: unless-stopped
    ports:
      - "4005:4005"
    env_file:
      - apps/backend/.env
    environment:
      - RACE_SERVICE_PORT=4005
      - DB_HOST=postgres
      - DB_PORT=5432
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - zetik-network

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  minio-data:
    driver: local
networks:
  zetik-network:
    driver: bridge
